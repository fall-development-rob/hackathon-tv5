# =============================================================================
# PostgreSQL Configuration for RuVector / Media Gateway
# =============================================================================
# Custom configuration optimized for vector operations and AI workloads
# This file overrides default PostgreSQL settings
# =============================================================================

# -----------------------------------------------------------------------------
# Connection Settings
# -----------------------------------------------------------------------------
max_connections = 200
superuser_reserved_connections = 3

# -----------------------------------------------------------------------------
# Memory Settings
# -----------------------------------------------------------------------------
# Shared memory for caching data and indices
shared_buffers = 256MB

# Memory for complex operations (sorting, hash tables)
work_mem = 16MB

# Memory for maintenance operations (VACUUM, CREATE INDEX)
maintenance_work_mem = 128MB

# Query planner's assumption about cache size
effective_cache_size = 1GB

# Shared memory for collecting execution statistics
shared_preload_libraries = 'pg_stat_statements'

# -----------------------------------------------------------------------------
# Write-Ahead Log (WAL) Settings
# -----------------------------------------------------------------------------
wal_level = replica
wal_buffers = 16MB
checkpoint_completion_target = 0.9
max_wal_size = 1GB
min_wal_size = 80MB

# -----------------------------------------------------------------------------
# Query Planner Settings
# -----------------------------------------------------------------------------
random_page_cost = 1.1
effective_io_concurrency = 200

# -----------------------------------------------------------------------------
# Logging Settings
# -----------------------------------------------------------------------------
logging_collector = on
log_directory = 'pg_log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB

# Log slow queries (queries taking longer than 1 second)
log_min_duration_statement = 1000

# Log all DDL statements
log_statement = 'ddl'

# Log connections and disconnections
log_connections = on
log_disconnections = on

# Log lock waits
log_lock_waits = on

# Include query duration in logs
log_duration = off

# -----------------------------------------------------------------------------
# Statistics Settings
# -----------------------------------------------------------------------------
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all

# pg_stat_statements extension settings
pg_stat_statements.max = 10000
pg_stat_statements.track = all

# -----------------------------------------------------------------------------
# Autovacuum Settings
# -----------------------------------------------------------------------------
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min

# -----------------------------------------------------------------------------
# Client Connection Settings
# -----------------------------------------------------------------------------
timezone = 'UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'

# -----------------------------------------------------------------------------
# Vector-Specific Settings (RuVector/pgvector)
# -----------------------------------------------------------------------------
# Optimized for AI workloads with high-dimensional vector operations
# HNSW index parameters are set in init scripts (m=16, ef_construction=64)

# HNSW query-time parameters (can be overridden per-query)
# Higher values = better recall, slower search
# Default: 40 (balanced), Range: 10-400
# Set via: SET hnsw.ef_search = 100;

# Vector operation memory allocation
# Increase for large batch vector operations
max_stack_depth = 7MB

# -----------------------------------------------------------------------------
# Performance Tuning for Vector Operations
# -----------------------------------------------------------------------------
# Parallel processing for vector similarity searches
# Improves performance on multi-core systems
max_parallel_workers_per_gather = 4
max_parallel_workers = 8
max_worker_processes = 8

# Enable JIT compilation for faster vector operations
jit = on
jit_above_cost = 100000
jit_inline_above_cost = 500000
jit_optimize_above_cost = 500000

# Increase statement timeout for large vector operations
# Batch embeddings and index builds can take time
statement_timeout = 300000  # 5 minutes

# Lock timeout to prevent deadlocks in concurrent vector updates
lock_timeout = 30000  # 30 seconds

# -----------------------------------------------------------------------------
# Security Settings
# -----------------------------------------------------------------------------
ssl = off  # Enable in production with proper certificates
password_encryption = scram-sha-256

# =============================================================================
# Vector Database Optimization Notes
# =============================================================================
#
# Memory Recommendations:
# - shared_buffers: 25% of total RAM (minimum 256MB for dev)
# - work_mem: 16MB-64MB for vector operations
# - maintenance_work_mem: 128MB-512MB for HNSW index builds
# - effective_cache_size: 50-75% of total RAM
#
# HNSW Index Tuning:
# - m (max connections): 16 (balanced), 32 (high recall), 8 (fast build)
# - ef_construction: 64 (balanced), 128 (high quality), 32 (fast build)
# - ef_search: 40 (default), 100+ (high recall), 10-20 (fast search)
#
# Performance Benchmarks (SPARC NFR-001):
# - p50 latency: <20ms for k=10 similarity search
# - p95 latency: <50ms for k=10 similarity search
# - p99 latency: <100ms for k=10 similarity search
# - Throughput: 1000+ queries/sec at 10k vector scale
#
# Scaling Recommendations:
# - <10k vectors: Single node with HNSW indexes
# - 10k-100k vectors: Optimize HNSW parameters, add read replicas
# - 100k-1M vectors: Consider partitioning by media_type or user cohort
# - >1M vectors: Deploy 3-node Raft cluster for horizontal scaling
#
# Security (Production):
# - Enable SSL/TLS: ssl = on
# - Configure SSL certificates in /var/lib/postgresql/data
# - Use scram-sha-256 password encryption (already enabled)
# - Implement role-based access control (RBAC)
# - Enable audit logging for compliance
#
# Monitoring:
# - Track pg_stat_statements for slow queries
# - Monitor HNSW index size: SELECT pg_size_pretty(pg_relation_size('idx_*_hnsw'))
# - Watch connection pool utilization
# - Alert on p95 latency > 50ms
# - Set up Prometheus exporter for metrics
#
# =============================================================================
